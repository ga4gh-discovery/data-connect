<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=../../css/style.css><link rel=stylesheet type=text/css href=../../css/page-layouts/content-header.css><link rel=stylesheet type=text/css href=../../css/sidebar/style.css><link rel=stylesheet type=text/css href=../../css/page-layouts/style.css><link rel=stylesheet type=text/css href=../../css/page-layouts/syntax.css><link rel=stylesheet type=text/css href=../../css/tabs/style.css><link rel=stylesheet type=text/css href=../../css/bootstrap.min.css><link rel=stylesheet href=../../override/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source Code Pro"><link rel=stylesheet href=../../feather-icons/css/iconfont.css><link rel=icon href=../../images/favicon.png type=image/x-icon><style>:root{--white: #ffffff;--primary: #fff;--secondary: #1E1F21;--sidebar-bg: #f6f6f8;--sidebar-primary: #1E1F21;--accent: #e34a3a;--grey100: ;--grey200: #F9F9FA;--grey300: ;--grey400: ;--grey500: ;--grey600: #969DAC;--grey700: ;--grey800: ;--grey900: ;--grey-head: #EFEFF3;--nav-highlight: }</style><title>GA4GH Discovery Search API | Implementation</title></head><body><!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=../../css/style.css><link rel=stylesheet type=text/css href=../../css/page-layouts/content-header.css><link rel=stylesheet type=text/css href=../../css/sidebar/style.css><link rel=stylesheet type=text/css href=../../css/page-layouts/style.css><link rel=stylesheet type=text/css href=../../css/page-layouts/syntax.css><link rel=stylesheet type=text/css href=../../css/tabs/style.css><link rel=stylesheet type=text/css href=../../css/bootstrap.min.css><link rel=stylesheet href=../../override/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source Code Pro"><link rel=stylesheet href=../../feather-icons/css/iconfont.css><link rel=icon href=../../images/favicon.png type=image/x-icon><style>:root{--white: #ffffff;--primary: #fff;--secondary: #1E1F21;--sidebar-bg: #f6f6f8;--sidebar-primary: #1E1F21;--accent: #e34a3a;--grey100: ;--grey200: #F9F9FA;--grey300: ;--grey400: ;--grey500: ;--grey600: #969DAC;--grey700: ;--grey800: ;--grey900: ;--grey-head: #EFEFF3;--nav-highlight: }</style><title>GA4GH Discovery Search API | Pagination and Long Running Queries</title></head><body><div class=sidebar id=sidebar-nav><button id=logo-collapse-btn onclick="(function(){document.getElementById('sidebar-nav').classList.toggle('show');document.getElementById('content').classList.toggle('showing-nav')})()">
<img id=logo src=../../images/logo.png alt="GA4GH Discovery Search API"></button><div class="card sidebar-card"><div class=collapse-header><a class=nav-link href=../../docs/getting-started/><i class="icon-layers navicon"></i><h3 class="sidebar-h1 mainitem">Quick Start</h3></a></div><div class=collapse><div class=nav-list><a class=nav-link href=../../docs/getting-started/introduction/><h3 class="sidebar-h2 subitem">Introduction</h3></a><a class=nav-link href=../../docs/getting-started/provision-data/><h3 class="sidebar-h2 subitem">Provision Data</h3></a><a class=nav-link href=../../docs/getting-started/consume-data/><h3 class="sidebar-h2 subitem">Consume Data</h3></a><a class=nav-link href=../../docs/getting-started/upload-result/><h3 class="sidebar-h2 subitem">Upload results</h3></a></div></div><div class=collapse-header><a class=nav-link href=../../docs/use-exisitng-data/><i class="icon-database navicon"></i><h3 class="sidebar-h1 mainitem">Use Existing Data</h3></a></div><div class=collapse><div class=nav-list><a class=nav-link href=../../docs/use-exisitng-data/retrofit-a-data-explorer/doc/><h3 class="sidebar-h2 subitem">Retrofit data explorers</h3></a><a class=nav-link href=../../docs/use-exisitng-data/tables-in-a-bucket/doc/><h3 class="sidebar-h2 subitem">Tables-in-a-bucket</h3></a><a class=nav-link href=../../docs/use-exisitng-data/using-preso/doc/><h3 class="sidebar-h2 subitem">Using Presto</h3></a></div></div><div class=collapse-header><a class=nav-link href=../../docs/security/><i class="icon-shield navicon"></i><h3 class="sidebar-h1 mainitem">Security</h3></a></div><div class=collapse><div class=nav-list><a class=nav-link href=../../docs/security/data-source/><h3 class="sidebar-h2 subitem">At the data source</h3></a><a class=nav-link href=../../docs/security/search-endpoint/><h3 class="sidebar-h2 subitem">At the search endpoint</h3></a></div></div><div class=collapse-header><a class=nav-link href=../../docs/reference/><i class="icon-book navicon"></i><h3 class="sidebar-h1 mainitem">Implementation</h3></a></div><div class="collapse show"><div class=nav-list><a class=nav-link href=../../docs/reference/pagination-long-queries/><h3 class="sidebar-h2 nav-highlight subitem" id=scrollto>Pagination and Long Running Queries</h3></a><a class=nav-link href=../../docs/reference/sql-functions/><h3 class="sidebar-h2 subitem">SQL Functions</h3></a><a class=nav-link href=../../docs/reference/sql-grammar/><h3 class="sidebar-h2 subitem">SQL Grammar</h3></a></div></div></div></div><div class=content id=content><div class=content-header><div id=search-input-div><button class=search-button id=search-button data-toggle=modal data-target=#search-input-modal onclick=setFocusToTextBox()><h3 class=search-button-text><i class="icon-search search-icon"></i>Find anything</h3></button><div class="modal search" id=search-input-modal><div id=search-input-modal class=modal-dialog><div id=search-input-div class=modal-content><input id=search-input type=text placeholder name=search autocomplete=off>
<span class=focus-border></span><section id=search-results class=search></section></div></div></div></div><div class=content-header-nav><a class=content-header-nav-link href=../../api><i class=icon-code></i><span>Open API 3 Reference</span></a>
<a class=content-header-nav-link href=https://github.com/ga4gh-discovery/ga4gh-search><i class=icon-github></i><span>Doc Source</span></a>
<a class=content-header-nav-link href=https://github.com/ga4gh-discovery/><i class=icon-github></i><span>Discovery Workstream</span></a></div></div><div class=text-area><h2>Pagination and Long Running Queries</h2><p><strong>Pagination sequence</strong></p><p>A pagination sequence is the singly-linked list of URLs formed by following the <code>next_page_url</code> property of the pagination section of an initial <code>TableData</code> or <code>ListTablesResponse</code>. A pagination sequence begins at the first response returned from any request that yields a <code>TableData</code> or <code>ListTablesResponse</code>, and ends at the page in the sequence whose pagination property is omitted, whose <code>pagination.next_page_url</code> is omitted, or whose <code>pagination.next_page_url</code> is <code>null</code>.</p><p>Servers <strong>may</strong> return a unique pagination sequence in response to successive requests for the same query, table data listing, or table listing.</p><p>Except for the last page, <code>pagination.next_page_url property</code> <strong>must</strong> be either an absolute URL or a relative reference as defined by <a href=https://tools.ietf.org/html/rfc3986#section-4.2>RFC 3986 section 4.2</a> whose base URL is the URL that the page containing the reference was fetched from.</p><p>Every non-empty <code>TableData</code> page in a pagination sequence <strong>must</strong> include a <code>data_model</code> property. If present, the <code>data_model</code> property <code>must</code> be a valid JSON Schema.</p><p>Across all <code>TableData</code> pages in the pagination sequence that have a <code>data_model</code> value, the <code>data_models</code> <strong>must</strong> be identical. Some <code>TableData</code> pages may lack a <code>data_model</code>. See the empty page rules below.</p><p>Servers <strong>may</strong> respond with an <code>HTTP 4xx</code> error code if the same page is requested more than once.</p><p>Due to both rules above, clients <strong>must not</strong> rely on the ability to re-fetch previously encountered pages.</p><p>Servers <strong>may</strong> include a Retry-After HTTP header in each response that is part of a pagination sequence, and clients <strong>must</strong> respect the delay specified by such header before attempting to fetch the next page.</p><p><strong>Empty TableData pages</strong></p><p>While many types of queries will be completed quickly, others will take minutes or even hours to yield a result. The simplest solution would be a synchronous design: query requests block until data is ready, then return a <code>TableData</code> response with the initial rows of the result set. However, asking clients to block for hours on a single HTTP response is fraught with difficulty: open connections are costly and fragile. If an intermediary times out the request, the results will be lost and the client must start over.</p><p>To allow servers to direct clients to poll for results rather than hold open HTTP connections for long-running queries, the following special pagination rules apply to empty pages.</p><p>An empty page is defined as a <code>TableData</code> object whose data property is a zero element array.</p><p>A pagination sequence MAY include any number of empty pages anywhere in the sequence.</p><p>An empty <code>TableData</code> page <strong>may</strong> omit its data_model property entirely. This allows servers to direct clients to poll for results before the result schema has been determined.</p><p>A server that returns an empty page <strong>should</strong> include a <code>Retry-After</code> header in the HTTP response. If a client encounters an empty page with no <code>Retry-After</code> header, the client <strong>should</strong> delay at least 1 second before requesting the next page.</p><p><strong>Example: Server returning empty pages to make client poll</strong></p><p>This example illustrates a server returning a series of empty pages to a client while it is preparing the result set. The client polls for results by following <code>next_page_url</code> at the rate specified by the server. The form of the pagination URLs are only an example of one possible scheme. Servers are free to employ any pagination URL scheme.</p><p><strong>Initial Request</strong></p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=err>POST</span> <span class=err>/search</span>
<span class=err>content-type:</span> <span class=err>application/json</span>

<span class=p>{</span><span class=nt>&#34;query&#34;</span><span class=p>:</span><span class=s2>&#34;select distinct gene_symbol from example_project.brca_exchange.v32&#34;</span><span class=p>}</span>

<span class=err>HTTP/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=err>OK</span>
<span class=err>content-type:</span> <span class=err>application/json</span>
<span class=err>retry-after:</span> <span class=mi>1000</span>

<span class=p>{</span><span class=nt>&#34;data&#34;</span><span class=p>:[],</span><span class=nt>&#34;pagination&#34;</span><span class=p>:{</span><span class=nt>&#34;next_page_url&#34;</span><span class=p>:</span><span class=s2>&#34;/search/v1/statement/abc123/queued/1&#34;</span><span class=p>}}</span>
</code></pre></div><p><strong>2nd request (Polling after sleeping for 1000ms)</strong></p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=err>GET</span> <span class=err>/search/v</span><span class=mi>1</span><span class=err>/statement/abc</span><span class=mi>123</span><span class=err>/queued/</span><span class=mi>1</span>

<span class=err>HTTP/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=err>OK</span>
<span class=err>content-type:</span> <span class=err>application/json</span>
<span class=err>retry-after:</span> <span class=mi>1000</span>

<span class=p>{</span><span class=nt>&#34;data&#34;</span><span class=p>:[],</span><span class=nt>&#34;pagination&#34;</span><span class=p>:{</span><span class=nt>&#34;next_page_url&#34;</span><span class=p>:</span><span class=s2>&#34;/search/v1/statement/abc123/queued/2&#34;</span><span class=p>}}</span>
</code></pre></div><p><strong>3rd request (Polling again after sleeping for 1000ms)</strong></p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=err>GET</span> <span class=err>/search/v</span><span class=mi>1</span><span class=err>/statement/abc</span><span class=mi>123</span><span class=err>/queued/</span><span class=mi>2</span>

<span class=err>HTTP/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=err>OK</span>
<span class=err>content-type:</span> <span class=err>application/json</span>
<span class=err>retry-after:</span> <span class=mi>1000</span>

<span class=p>{</span><span class=nt>&#34;data&#34;</span><span class=p>:[],</span><span class=nt>&#34;pagination&#34;</span><span class=p>:{</span><span class=nt>&#34;next_page_url&#34;</span><span class=p>:</span><span class=s2>&#34;/search/v1/statement/abc123/executing/1&#34;</span><span class=p>}}</span>
</code></pre></div><p><strong>4th request (Polling again after sleeping for 1000ms)</strong></p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=err>GET</span> <span class=err>/search/v</span><span class=mi>1</span><span class=err>/statement/abc</span><span class=mi>123</span><span class=err>/executing/</span><span class=mi>1</span>

<span class=err>HTTP/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=err>OK</span>
<span class=err>content-type:</span> <span class=err>application/json</span>

<span class=p>{</span><span class=nt>&#34;data_model&#34;</span><span class=p>:{</span><span class=nt>&#34;description&#34;</span><span class=p>:</span><span class=s2>&#34;Automatically generated schema&#34;</span><span class=p>,</span><span class=nt>&#34;$schema&#34;</span><span class=p>:</span><span class=s2>&#34;http://json-schema.org/draft-07/schema#&#34;</span><span class=p>,</span><span class=nt>&#34;properties&#34;</span><span class=p>:{</span><span class=nt>&#34;gene_symbol&#34;</span><span class=p>:{</span><span class=nt>&#34;format&#34;</span><span class=p>:</span><span class=s2>&#34;varchar&#34;</span><span class=p>,</span><span class=nt>&#34;type&#34;</span><span class=p>:</span><span class=s2>&#34;string&#34;</span><span class=p>}}},</span><span class=nt>&#34;data&#34;</span><span class=p>:[{</span><span class=nt>&#34;gene_symbol&#34;</span><span class=p>:</span><span class=s2>&#34;BRCA2&#34;</span><span class=p>},{</span><span class=nt>&#34;gene_symbol&#34;</span><span class=p>:</span><span class=s2>&#34;BRCA1&#34;</span><span class=p>}],</span><span class=nt>&#34;pagination&#34;</span><span class=p>:{</span><span class=nt>&#34;next_page_url&#34;</span><span class=p>:</span><span class=s2>&#34;/search/v1/statement/abc123/executing/2&#34;</span><span class=p>}}</span>
</code></pre></div><p><strong>Final request (no delay because page was nonempty and no retry-after header was present on the response)</strong></p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=err>GET</span> <span class=err>/search/v</span><span class=mi>1</span><span class=err>/statement/abc</span><span class=mi>123</span><span class=err>/executing/</span><span class=mi>2</span>

<span class=err>HTTP/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=err>OK</span>
<span class=err>content-type:</span> <span class=err>application/json</span>

<span class=p>{</span><span class=nt>&#34;data_model&#34;</span><span class=p>:{</span><span class=nt>&#34;description&#34;</span><span class=p>:</span><span class=s2>&#34;Automatically generated schema&#34;</span><span class=p>,</span><span class=nt>&#34;$schema&#34;</span><span class=p>:</span><span class=s2>&#34;http://json-schema.org/draft-07/schema#&#34;</span><span class=p>,</span><span class=nt>&#34;properties&#34;</span><span class=p>:{</span><span class=nt>&#34;gene_symbol&#34;</span><span class=p>:{</span><span class=nt>&#34;format&#34;</span><span class=p>:</span><span class=s2>&#34;varchar&#34;</span><span class=p>,</span><span class=nt>&#34;type&#34;</span><span class=p>:</span><span class=s2>&#34;string&#34;</span><span class=p>}}},</span><span class=nt>&#34;data&#34;</span><span class=p>:[],</span><span class=nt>&#34;pagination&#34;</span><span class=p>:{}}</span>
</code></pre></div><p><strong>Example: Client algorithm for consuming TableData pages</strong></p><p>The algorithm provided here simply illustrates one way to comply with the rules above. Any algorithm that satisfies all rules acceptable.</p><ol><li>Start with an empty data buffer and undefined data model.</li><li>Loop:<ol><li>If the response is an <strong>error</strong>, report the <strong>error</strong> and <strong>abort</strong></li><li>If no <code>data_model</code> has been seen so far, check if this page contains a <code>data_model</code>. If so, define the data model for the whole pagination sequence as this pageâ€™s <code>data_model</code>.</li><li>Append the row data from the current page to the data buffer (there may be 0 rows on any given page)</li><li>Delay for the time specified in the <code>Retry-After</code> HTTP response header for the current page (default is no delay)</li><li>If there is a pagination object and it has a non-null <code>next_page_url</code>, fetch that URL, make that response the current page, and start back at step 2a; otherwise end.</li></ol></li></ol></div></div><script src=../../js/jquery-3.5.1.min.js></script><script src=../../js/bootstrap.min.js></script><script src=https://unpkg.com/lunr/lunr.js></script><script>document.getElementById("scrollto").scrollIntoView(true);</script><script type=text/javascript>var idx,searchInput,searchResults=null
var documents=[]
function renderSearchResults(results){if(results.length>0){if(results.length>9){results=results.slice(0,10)}
searchResults.innerHTML=''
results.forEach(result=>{var article=document.createElement('article')
var uri="/ga4gh-search-docs"+result.ref.replace("/index.json","")
article.innerHTML=`
            <a href="${uri}" class="search-result-item"><p class="search-result-title">${documents[result.ref].title}</p> <i class="icon-external-link"></i></a>
            `
searchResults.appendChild(article)})}else{searchResults.innerHTML='<p>No results found.</p>'}}
function registerSearchHandler(){searchInput.oninput=function(event){if(searchInput.value==''){searchResults.innerHTML=''}else{var query=event.target.value
var results=idx.search(query+'*')
renderSearchResults(results)}}
searchInput.focus()
searchInput.placeholder=''}
$('#search-input-modal').on('shown.bs.modal',function(){$('#search-input').trigger('focus')})
window.onload=function(){searchInput=document.getElementById('search-input')
searchResults=document.getElementById('search-results')
fetch('/ga4gh-search-docs/docs/index.json',{method:'get'}).then(res=>res.json()).then(res=>{idx=lunr(function(){this.ref('url')
this.field('title')
this.field('content')
res.forEach(function(doc){this.add(doc)
documents[doc.url]={'title':doc.title,'content':doc.content,}},this)})
registerSearchHandler()}).catch(err=>{searchResults.innerHTML=`<p>${err}</p>`})}</script></body></html><script src=../../js/jquery-3.5.1.min.js></script><script src=../../js/bootstrap.min.js></script><script src=https://unpkg.com/lunr/lunr.js></script><script>document.getElementById("scrollto").scrollIntoView(true);</script><script type=text/javascript>var idx,searchInput,searchResults=null
var documents=[]
function renderSearchResults(results){if(results.length>0){if(results.length>9){results=results.slice(0,10)}
searchResults.innerHTML=''
results.forEach(result=>{var article=document.createElement('article')
var uri="/ga4gh-search-docs"+result.ref.replace("/index.json","")
article.innerHTML=`
            <a href="${uri}" class="search-result-item"><p class="search-result-title">${documents[result.ref].title}</p> <i class="icon-external-link"></i></a>
            `
searchResults.appendChild(article)})}else{searchResults.innerHTML='<p>No results found.</p>'}}
function registerSearchHandler(){searchInput.oninput=function(event){if(searchInput.value==''){searchResults.innerHTML=''}else{var query=event.target.value
var results=idx.search(query+'*')
renderSearchResults(results)}}
searchInput.focus()
searchInput.placeholder=''}
$('#search-input-modal').on('shown.bs.modal',function(){$('#search-input').trigger('focus')})
window.onload=function(){searchInput=document.getElementById('search-input')
searchResults=document.getElementById('search-results')
fetch('/ga4gh-search-docs/docs/index.json',{method:'get'}).then(res=>res.json()).then(res=>{idx=lunr(function(){this.ref('url')
this.field('title')
this.field('content')
res.forEach(function(doc){this.add(doc)
documents[doc.url]={'title':doc.title,'content':doc.content,}},this)})
registerSearchHandler()}).catch(err=>{searchResults.innerHTML=`<p>${err}</p>`})}</script></body></html>